# Copyright (c) 2012      Mellanox Technologies, Inc.
#                         All rights reserved.
# $COPYRIGHT$
#
# Additional copyrights may follow
#
# $HEADER$
#

# don't stop with an error if we don't pack all files at once
%define _unpackaged_files_terminate_build  0
# avoid this error: 
# /usr/lib/rpm/debugedit: canonicalization unexpectedly shrank by one character
%define debug_package %{nil}


# variables replaced by buildrpm.sh script
%define oshmem_name @OSHMEM_NAME@
%define oshmem_configure_params @OSHMEM_CONFIGURE_PARAMS@
%define oshmem_version @OSHMEM_VERSION@
%define oshmem_release @OSHMEM_RELEASE@
%define oshmem_cflags @OSHMEM_CFLAGS@
%define oshmem_build @OSHMEM_BUILD@
%{!?configure_opts: %define configure_opts %{nil}}



#
# global Open SHMEM stuff
#

%{!?oshmem_name: %define oshmem_name openshmem}
%{!?oshmem_version: %define oshmem_version 2.0}
%{!?oshmem_release: %define oshmem_release 0}
%{!?oshmem_build: %define oshmem_build %{nil}}
%{!?oshmem_name_prefix: %define oshmem_name_prefix %{nil}}
%{!?oshmem_prefix: %define oshmem_prefix /opt/mellanox/%{oshmem_name_prefix}%{oshmem_name}/%{oshmem_version}}

%define oshmem_long_ver %{oshmem_name}-%{oshmem_version}.%{oshmem_build}
%define oshmem_source %{oshmem_long_ver}.tar.gz
%define shell_scripts_path %{_bindir}
%define shell_scripts_basename shmemvars
# fix configure 
#
%{!?extra_cflags: %define extra_cflags %{nil}}
#
%define _prefix %{oshmem_prefix}
%define _sysconfdir %{_prefix}/etc
%define _libdir %{_prefix}/lib
%define _includedir %{_prefix}/include

#
# compiler settings
#
%define oshmem_compiler default
%define oshmem_cc  " "
%define oshmem_cxx " "
%define oshmem_f77 " "
%define oshmem_fc  " "


######################################################################
#
# Build section
#
######################################################################
Summary: Mellanox SHMEM parallel programming library.
Name: %{oshmem_name_prefix}%{oshmem_name}
Version: %{oshmem_version}
Release: %{oshmem_release}
License: Proprietary
Group: Development/Libraries
URL: http://www.mellanox.com
Source0: %{oshmem_source}
BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
Requires: libibverbs mxm fca
BuildRequires: gcc-c++ libstdc++ libstdc++-devel libibverbs-devel fca mxm
Provides: shmem
Packager: mellanox
Vendor: mellanox
Prefix: %{_prefix}
%description

The Mellanox SHMEM library provides fast inter-processor communication for large 
messages using data passing and one-sided communication techniques.

The Mellanox SHMEM API based on OpenSHMEM standard from http://www.openshmem.org/

%prep
rm -rf $RPM_BUILD_ROOT
%setup -q -n %{oshmem_long_ver}

%build
OSHMEM_CONFIGURE_FLAGS="%{oshmem_configure_params}"
EXTRA_CFLAGS="%{extra_cflags}"
if [ "%{oshmem_compiler}" != "default" ]; then
OSHMEM_CONFIGURE_FLAGS="$OSHMEM_CONFIGURE_FLAGS CC=%{oshmem_cc} CXX=%{oshmem_cxx} F77=%{oshmem_f77} FC=%{oshmem_fc}"
fi
CFLAGS="$EXTRA_CFLAGS" && %configure $OSHMEM_CONFIGURE_FLAGS %{configure_opts} 
make -j4

%install
rm -rf $RPM_BUILD_ROOT
%{__make} -j4 install DESTDIR=$RPM_BUILD_ROOT 

%{__mkdir_p} $RPM_BUILD_ROOT/%{shell_scripts_path}
cat <<EOF > $RPM_BUILD_ROOT/%{shell_scripts_path}/%{shell_scripts_basename}.sh
# NOTE: This is an automatically-generated file!  (generated by the
# Open MPI RPM).  Any changes made here will be lost if the RPM is
# uninstalled or upgraded.

# PATH
if test -z "\`echo \$PATH | grep %{_bindir}\`"; then
        PATH=%{_bindir}:\${PATH}
            export PATH
            fi

# LD_LIBRARY_PATH
if test -z "\`echo \$LD_LIBRARY_PATH | grep %{_libdir}\`"; then
        LD_LIBRARY_PATH=%{_libdir}\${LD_LIBRARY_PATH:+:}\${LD_LIBRARY_PATH}
            export LD_LIBRARY_PATH
            fi

# MANPATH
if test -z "\`echo \$MANPATH | grep %{_mandir}\`"; then
        MANPATH=%{_mandir}:\${MANPATH}
            export MANPATH
            fi

# MPI_ROOT
MPI_ROOT=%{_prefix}
export MPI_ROOT
EOF

cat>>$RPM_BUILD_ROOT/%{_sysconfdir}/openmpi-mca-params.conf<<EOF
opal_event_include=epoll
coll_fca_enable = 0
scoll_fca_enable = 0
mca_component_show_load_errors = 0
EOF

%clean
#test "x$RPM_SOURCE_DIR" != "x" && rm -rf $RPM_SOURCE_DIR
test "x$RPM_BUILD_DIR"  != "x" && rm -rf $RPM_BUILD_DIR/*
test "x$RPM_BUILD_ROOT" != "x" && rm -rf $RPM_BUILD_ROOT

%files 
%defattr(-,root,root,-)
%{oshmem_prefix}


